FROM mcr.microsoft.com/devcontainers/typescript-node:22-bookworm

ARG WEB_WORKSPACE_PATH
ARG WEB_WORKSPACE_USER
ARG WEB_WORKSPACE_GROUP
ARG WORKSPACE_PATH
ARG WORKSPACE_USER

USER root

WORKDIR ${WORKSPACE_PATH}${WEB_WORKSPACE_PATH}

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
    && apt-get -y install --no-install-recommends \
        curl \
        gnupg \
        lsb-release \
        software-properties-common \
        postgresql-client \
        zsh \
    && curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list \
    && apt-get update \
    && apt-get -y install --no-install-recommends gh \
    && apt-get -y upgrade \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

RUN ZSH_PATH=$(which zsh); \
    if [ -z "$ZSH_PATH" ]; then \
        echo "Error: zsh not found by 'which' after installation. Make sure zsh is installed and in PATH." >&2; \
        exit 1; \
    fi; \
    echo "Found zsh at: $ZSH_PATH"; \
    # Add zsh to /etc/shells if it's not already there
    if ! grep -qxF "$ZSH_PATH" /etc/shells; then \
        echo "Adding $ZSH_PATH to /etc/shells"; \
        echo "$ZSH_PATH" >> /etc/shells; \
    else \
        echo "$ZSH_PATH already in /etc/shells"; \
    fi && \
    echo "Attempting to set $ZSH_PATH as shell for user ${WEB_WORKSPACE_USER}"; \
    usermod -s "$ZSH_PATH" "${WEB_WORKSPACE_USER}" && \
    echo "Successfully set $ZSH_PATH as shell for ${WEB_WORKSPACE_USER}"

USER ${WEB_WORKSPACE_USER}

LABEL dev.containers.metadata='{ \
  "initializeCommand": "echo \"Starting Dev Container setup...\"", \
  "postCreateCommand": "sudo chown -R ${localEnv:WORKSPACE_USER}:${localEnv:WORKSPACE_GROUP:-${localEnv:WORKSPACE_USER}} ${localEnv:WORKSPACE_PATH}${localEnv:WEB_WORKSPACE_PATH}", \
  "postStartCommand": "cd ${localEnv:WORKSPACE_PATH}${localEnv:WEB_WORKSPACE_PATH} && yarn install --frozen-lockfile || (yarn install && npx prisma generate)", \
  "postAttachCommand": { \
    "server": "echo \"Attached to AutomaLarWEB Dev Container! ðŸ”¥\" && git config --global --add safe.directory ${localEnv:WORKSPACE_PATH}${localEnv:WEB_WORKSPACE_PATH}" \
  }, \
  "portsAttributes": { \
    "3000": { "label": "Next.js App", "onAutoForward": "openPreview" }, \
    "6006": { "label": "Storybook", "onAutoForward": "notify" }, \
    "5432": { "label": "PostgreSQL DB", "onAutoForward": "silent" }, \
    "5555": { "label": "Prisma Studio", "onAutoForward": "openPreview" }, \
    "8000": { "label": "Cognee MCP", "onAutoForward": "silent" } \
  }, \
  "customizations": { \
    "vscode": { \
      "extensions": [ \
        "dbaeumer.vscode-eslint", \
        "esbenp.prettier-vscode", \
        "eamodio.gitlens", \
        "github.vscode-pull-request-github", \
        "ms-azuretools.vscode-docker", \
        "ms-vscode.vscode-typescript-next", \
        "streetsidesoftware.code-spell-checker", \
        "usernamehw.errorlens", \
        "oderwat.indent-rainbow", \
        "christian-kohler.path-intellisense", \
        "formulahendry.auto-rename-tag", \
        "wayou.vscode-todo-highlight", \
        "mikestead.dotenv", \
        "wix.vscode-import-cost", \
        "pkief.material-icon-theme", \
        "ms-vsliveshare.vsliveshare", \
        "rangav.vscode-thunder-client", \
        "johnpapa.vscode-peacock", \
        "bradlc.vscode-tailwindcss", \
        "orta.vscode-jest", \
        "prisma.prisma", \
        "slevesque.shader", \
        "RooVeterinaryInc.roo-cline" \
        "editorconfig.editorconfig" \
      ] \
    } \
  } \
}'
